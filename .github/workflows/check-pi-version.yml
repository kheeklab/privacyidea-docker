name: Sync PI Tags

on:
  schedule:
    - cron: '0 0 * * *' # Daily at midnight
  workflow_dispatch: # Allows manually triggering

jobs:
  sync-tags:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed to create and push tags

    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Get PI tags
        id: get-pi-tags
        run: |
          echo "Fetching PI release tags from GitHub API (first page, excluding pre-releases)..."
          PI_TAGS=$(curl -fsSL -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/privacyidea/privacyidea/releases" \
            | jq -r '.[] | select(.prerelease == false) | .tag_name' 2>/dev/null || true)
          # Convert newlines to spaces
          PI_TAGS_FORMATTED=$(echo "$PI_TAGS" | tr '\n' ' ')
          echo "pi_tags=$PI_TAGS_FORMATTED" >> $GITHUB_ENV

      - name: Get PI versions on PyPI
        id: get-pi-pypi-versions
        run: |
          echo "Fetching privacyIDEA release versions from PyPI..."
          PYPI_VERSIONS=$(curl -fsSL "https://pypi.org/pypi/privacyIDEA/json" \
            | jq -r '.releases | keys[]' 2>/dev/null || true)
          PYPI_VERSIONS_FORMATTED=$(echo "$PYPI_VERSIONS" | tr '\n' ' ')
          echo "pypi_versions=$PYPI_VERSIONS_FORMATTED" >> $GITHUB_ENV

      - name: Get existing tags
        id: get-existing-tags
        run: |
          git fetch --tags
          EXISTING_TAGS=$(git tag -l)
          # Convert newlines to spaces
          EXISTING_TAGS_FORMATTED=$(echo "$EXISTING_TAGS" | tr '\n' ' ')
          echo "existing_tags=$EXISTING_TAGS_FORMATTED" >> $GITHUB_ENV

      - name: Process missing tags
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          # Convert existing tags to a pattern for quick matching
          EXISTING_TAGS_PATTERN=" ${{ env.existing_tags }} "
          # Convert PyPI versions to a pattern for quick matching
          PYPI_VERSIONS_PATTERN=" ${{ env.pypi_versions }} "
          # Counter for processed tags
          PROCESSED=0

          # Process each PI tag
          for tag in ${{ env.pi_tags }}; do
            # Only process version tags starting with 'v'
            if [[ ! "$tag" =~ ^v ]]; then
              continue
            fi

            # Check if tag exists
            if [[ "$EXISTING_TAGS_PATTERN" == *" $tag "* ]]; then
              echo "Tag $tag already exists, skipping"
              continue
            fi

            # Only trigger when this version is available on PyPI
            pypi_version="${tag#v}"
            if [[ "$PYPI_VERSIONS_PATTERN" != *" $pypi_version "* ]]; then
              echo "Tag $tag is not published on PyPI yet (missing $pypi_version), skipping"
              continue
            fi

            # Create and push tag (only need to do this once)
            echo "Creating new tag: $tag"

            git tag "$tag"
            git push origin "$tag"

            # Trigger build workflow
            echo "Triggering build for tag $tag"
            curl -X POST \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Authorization: token $GH_PAT" \
              https://api.github.com/repos/${{ github.repository }}/actions/workflows/release.yml/dispatches \
              -d '{
                "ref": "'"$tag"'",
                "inputs": {
                  "pi_version": "'"$tag"'"
                }
              }'

            # Count processed tag
            PROCESSED=$((PROCESSED+1))
          done

          echo "Process completed. Created $PROCESSED new tags."
          echo "The buildx workflow will be automatically triggered for these tags."

      - name: Summary
        run: |
          echo "# PI Tags Synchronization" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- PI tags found: $(echo "${{ env.pi_tags }}" | wc -w)" >> $GITHUB_STEP_SUMMARY
          echo "- PyPI versions found: $(echo "${{ env.pypi_versions }}" | wc -w)" >> $GITHUB_STEP_SUMMARY
          echo "- Existing tags: $(echo "${{ env.existing_tags }}" | wc -w)" >> $GITHUB_STEP_SUMMARY
          echo "- New tags created: $(git tag -l | wc -w) - $(echo "${{ env.existing_tags }}" | wc -w)" >> $GITHUB_STEP_SUMMARY
